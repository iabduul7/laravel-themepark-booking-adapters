name: Code Style Check

on:
  push:
    branches: [dev, 'feature/*', 'bugfix/*', 'hotfix/*']
    paths:
      - '**/*.php'
      - 'composer.json'
      - 'pint.json'

concurrency:
  group: style-check-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code-style-check:
    runs-on: ubuntu-latest
    name: ğŸ¨ Code Style Check
    
    # Skip if commit message contains '[skip style]'
    if: "!contains(github.event.head_commit.message, '[skip style]')"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          extensions: dom, curl, libxml, mbstring, zip
          coverage: none

      - name: Install dependencies
        run: composer update --prefer-dist --no-interaction

      - name: Check code style
        run: |
          if ! composer format:check --quiet; then
            echo "âŒ Code style issues detected!"
            echo "ğŸ’¡ Please run 'composer format' locally and commit the changes."
            echo "ğŸ’¡ Git hooks should prevent this - make sure they are installed with 'composer hooks:install'"
            exit 1
          else
            echo "âœ… Code style is compliant"
          fi

  notification:
    runs-on: ubuntu-latest
    needs: [code-style-check]
    if: needs.code-style-check.result == 'success'
    name: ğŸ“¢ Success Notification

    steps:
      - name: Success notification
        run: |
          echo "ğŸ¨ Code style check passed for ${{ github.ref_name }}"
          echo "ğŸ“ All PHP files are properly formatted"