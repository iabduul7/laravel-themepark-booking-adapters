#!/usr/bin/env bash

# Pre-commit hook for style checking - prevents commits with style issues
# This runs on every commit to catch issues before they enter the repository

echo "ğŸ”„ Running pre-commit style checks..."

# Get list of staged PHP files
staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(php)$' || true)

if [ -z "$staged_files" ]; then
    echo "â„¹ï¸  No PHP files staged for commit."
    exit 0
fi

echo "ğŸ“ Checking $(echo "$staged_files" | wc -l) staged PHP files with Pint..."

# Get the repository root directory
repo_root=$(git rev-parse --show-toplevel)

# Check if vendor/bin/pint exists in the repo root
if [ ! -f "$repo_root/vendor/bin/pint" ]; then
    echo "âŒ Laravel Pint not found at $repo_root/vendor/bin/pint!"
    echo "ğŸ’¡ Please run 'composer install' in the repository root first."
    exit 1
fi

# Change to repo root for running Pint
cd "$repo_root"

# Run Pint on staged files only - use --test to check without fixing
if ! echo "$staged_files" | xargs ./vendor/bin/pint --test --quiet; then
    echo ""
    echo "âŒ Code style issues detected in staged files!"
    echo "ğŸ’¡ Run the following commands to fix:"
    echo "   composer format"
    echo "   git add ."
    echo "   git commit"
    echo ""
    echo "Or fix specific files:"
    echo "$staged_files" | sed 's/^/   .\/vendor\/bin\/pint /'
    echo ""
    exit 1
fi

echo "âœ… Pre-commit style checks passed!"
echo ""